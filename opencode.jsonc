{
  "$schema": "https://opencode.ai/config.json",

  // Edge Stack - OpenCode Configuration
  // Migrated from Claude Code plugin architecture to script-native OpenCode
  // Optimized for Claude 4.5 Opus with token-efficient "Hard Tools"

  // === Model Configuration ===
  "model": {
    "primary": "claude-opus-4-5-20251101",
    "fallback": "claude-sonnet-4-20250514",
    "lightweight": "claude-haiku-4-20250514"
  },

  // === Instructions (Rules Files) ===
  // Loaded automatically to provide project context
  "instructions": [
    "AGENTS.md",
    ".opencode/knowledge/guidelines.md",
    ".opencode/knowledge/cloudflare-patterns.md"
  ],

  // === Key Bindings ===
  // Quick access to common operations (press leader key first, then shortcut)
  // Example: Ctrl+X then w = start work session
  "keybinds": {
    "leader": "ctrl+x",
    // Session management
    "new_session": "n",
    "open_session": "o",
    "share": "s",
    "undo": "u",
    "redo": "r",
    "help": "h",
    "quit": "q",
    // Edge Stack workflows
    "work": "w",           // /es-work - start feature development
    "validate": "v",       // /es-validate - pre-commit checks
    "code_review": "c",    // /es-review - code review
    "tasks": "t",          // bd ready - check pending tasks
    "find": "f",           // mgrep prompt - semantic search
    "deploy": "d"          // /es-release - release workflow
  },

  // === Formatters ===
  // Auto-format files after editing
  "formatter": {
    "prettier": {
      "command": ["npx", "prettier", "--write", "$FILE"],
      "extensions": [".js", ".ts", ".jsx", ".tsx", ".json", ".md", ".css"]
    }
  },

  // === Context Triggers (Progressive Disclosure) ===
  // Load context dynamically based on conversation content
  "context_triggers": {
    // Cloudflare resource selection - when to use KV vs DO vs R2
    "rate limit|strong consistency|Durable Object|DO pattern|WebSocket": {
      "load": [".opencode/knowledge/cloudflare-patterns.md"],
      "agent": "durable-objects"
    },
    // Runtime compatibility issues - Node.js API violations
    "process\\.env|require\\(|Buffer|fs module|Node\\.js|not working in Workers": {
      "load": [".opencode/knowledge/cloudflare-patterns.md"],
      "agent": "runtime-guardian"
    },
    // UI component questions - shadcn/ui props and patterns
    "shadcn|Button|Card|Dialog|variant|className|component prop": {
      "mcp": "shadcn",
      "agent": "ui-validator"
    },
    // Design and aesthetics - prevent generic AI patterns
    "Inter font|Roboto|purple gradient|generic|aesthetic|design review|distinctive": {
      "load": [".opencode/knowledge/design-anti-patterns.md"]
    },
    // Authentication setup
    "auth|login|session|OAuth|passkey|better-auth|sign in": {
      "mcp": "better-auth",
      "load": [".opencode/knowledge/guidelines.md"]
    },
    // Performance optimization
    "cold start|bundle size|slow|optimize|performance|latency|edge": {
      "load": [".opencode/knowledge/cloudflare-patterns.md"],
      "agent": "architect"
    },
    // Code review requests
    "review|PR|pull request|check this|what's wrong|look at": {
      "agent": "reviewer"
    },
    // Semantic code search - use mgrep for intent-based queries
    "find.*where|search.*for|look.*for|how does.*work|what.*calls|who uses": {
      "load": [".opencode/knowledge/mgrep-patterns.md"]
    },
    // Task management - beads for cross-session persistence
    "task|todo|pending|what.*next|continue|pick up|left off|multi-session": {
      "load": [".opencode/knowledge/beads-patterns.md"]
    },
    // Model selection guidance
    "which model|what model|use opus|use gemini|daily driver|escalate": {
      "load": [".opencode/knowledge/model-strategy.md"]
    }
  },

  // === MCP Server Configuration ===
  // Heavy servers use defer_loading to prevent context overload at startup
  "mcp": {
    // Primary documentation lookup - ALWAYS ENABLED
    "context7": {
      "type": "local",
      "command": ["npx", "-y", "@context7/mcp"],
      "enabled": true,
      "description": "Documentation lookup for 100+ frameworks including Cloudflare (Workers, KV, R2, D1, Pages), TanStack Router, React"
    },

    // UI component documentation - ALWAYS ENABLED (prevents hallucinated props)
    "shadcn": {
      "type": "local",
      "command": ["npx", "shadcn@latest", "mcp"],
      "enabled": true,
      "description": "shadcn/ui component documentation - prevents prop hallucination"
    },

    // Tailwind CSS utilities - ALWAYS ENABLED
    "tailwindcss": {
      "type": "local",
      "command": ["npx", "-y", "tailwindcss-mcp-server"],
      "enabled": true,
      "description": "Tailwind CSS utilities, CSS-to-Tailwind conversion, component templates"
    },

    // Better Auth - ENABLED for auth patterns
    "better-auth": {
      "type": "remote",
      "url": "https://mcp.chonkie.ai/better-auth/better-auth-builder/mcp",
      "enabled": true,
      "description": "Better Auth implementation patterns for Tanstack Start"
    },

    // Heavy servers with defer_loading to reduce startup context
    "playwright": {
      "type": "local",
      "command": ["npx", "@playwright/mcp@latest"],
      "enabled": true,
      "defer_loading": true,
      "description": "Browser automation and E2E testing - loaded on demand"
    },

    "package-registry": {
      "type": "local",
      "command": ["npx", "-y", "package-registry-mcp"],
      "enabled": true,
      "defer_loading": true,
      "description": "NPM, Cargo, PyPI, NuGet package search - loaded on demand"
    },

    // Disabled servers (redundant or require auth)
    "cloudflare-docs": {
      "type": "remote",
      "url": "https://docs.mcp.cloudflare.com/mcp",
      "enabled": false,
      "description": "Cloudflare docs - redundant with context7"
    },

    "tanstack-router": {
      "type": "local",
      "command": ["npx", "-y", "mcp-remote", "https://gitmcp.io/TanStack/router"],
      "enabled": false,
      "description": "TanStack Router docs - redundant with context7"
    },

    "polar": {
      "type": "remote",
      "url": "https://mcp.polar.sh/mcp/polar-mcp",
      "enabled": false,
      "description": "Polar billing - requires authentication"
    }
  },

  // === Global Tool Permissions ===
  // Disable heavy MCP tools globally, enable per-agent
  "tools": {
    "playwright*": false,
    "package-registry*": false
  },

  // === Agent Configuration ===
  // Grouped by model class for easy updates when new models release
  // To update: find/replace model ID within each class section
  "agent": {
    // ┌─────────────────────────────────────────────────────────────┐
    // │ MODEL CLASS: OPUS (deep thinking, complex reasoning)        │
    // │ Current: claude-opus-4-5-20251101                           │
    // └─────────────────────────────────────────────────────────────┘
    "architect": {
      "model": "claude-opus-4-5-20251101",
      "temperature": 0.3,
      "description": "Senior Cloudflare Architect - edge-first design, resource selection, Workers patterns",
      "tools": {
        "context7*": true,
        "shadcn*": true
      }
    },
    "feedback-codifier": {
      "model": "claude-opus-4-5-20251101",
      "temperature": 0.2,
      "description": "Extracts and validates patterns from feedback, updates knowledge base",
      "tools": {
        "context7*": true
      }
    },
    "reviewer": {
      "model": "claude-opus-4-5-20251101",
      "description": "Comprehensive code review with confidence scoring",
      "tools": {
        "context7*": true,
        "shadcn*": true
      }
    },

    // ┌─────────────────────────────────────────────────────────────┐
    // │ MODEL CLASS: SONNET (balanced speed/quality)                │
    // │ Current: claude-sonnet-4-20250514                           │
    // └─────────────────────────────────────────────────────────────┘
    "testing": {
      "model": "claude-sonnet-4-20250514",
      "description": "E2E testing with Playwright",
      "tools": {
        "playwright*": true
      }
    },
    "reviewer-fast": {
      "model": "claude-sonnet-4-20250514",
      "description": "Quick code review for small changes",
      "tools": {
        "context7*": true,
        "shadcn*": true
      }
    },

    // ┌─────────────────────────────────────────────────────────────┐
    // │ MODEL CLASS: HAIKU (fast, cheap, deterministic tasks)       │
    // │ Current: claude-haiku-4-20250514                            │
    // └─────────────────────────────────────────────────────────────┘
    "runtime-validator": {
      "model": "claude-haiku-4-20250514",
      "description": "Workers runtime compatibility validator - catches forbidden APIs",
      "tools": {}
    },
    "binding-analyzer": {
      "model": "claude-haiku-4-20250514",
      "description": "Analyzes wrangler.toml bindings and generates TypeScript interfaces"
    },
    "ui-validator": {
      "model": "claude-haiku-4-20250514",
      "description": "Validates shadcn/ui component usage",
      "tools": {
        "shadcn*": true
      }
    }
  },

  // === Security Permissions ===
  "permissions": {
    // Allow reading env files (needed for worktree copying)
    "allow": [
      "read:.env*",
      "read:wrangler.toml"
    ],
    // Prevent destructive operations
    "deny": [
      "bash:rm -rf",
      "bash:git push --force",
      "bash:git reset --hard"
    ]
  }
}
